!function(){function showPage(li,id){$("#cnt").html(waitingBlock),$("#menu-pages").find("li").removeClass("active"),li&&$(li.parentNode).addClass("active"),currentPage=id,refresh()}function summary(){var sum={Surveys:{},Reports:{}};return interns.forEach(function(i){i.Reports.forEach(function(r){sum.Reports[r.Kind]||(sum.Reports[r.Kind]={Missing:0,Pending:0,Total:0}),nbDaysLate(new Date(r.Deadline),new Date)<0&&new Date(r.Delivery).getTime()<0&&sum.Reports[r.Kind].Missing++,new Date(r.Delivery).getTime()>0&&r.Grade<0&&sum.Reports[r.Kind].Pending++,sum.Reports[r.Kind].Total++}),i.Surveys.forEach(function(s){sum.Surveys[s.Kind]||(sum.Surveys[s.Kind]={Missing:0,Total:0}),sum.Surveys[s.Kind].Total++,0==Object.keys(s.Answers)&&sum.Surveys[s.Kind].Missing++})}),sum}function refresh(){"myStudents"==currentPage?displayMyStudents():"conventions"==currentPage?displayMyConventions():"assignments"==currentPage?displayTutors():"privileges"==currentPage?showPrivileges():"pending"==currentPage?showPendingConventions():"juries"==currentPage?showJuryService():"service"==currentPage?showService():"status"==currentPage?showStatus():"defenses-schedule"==currentPage?showDefenses():"defense-program"==currentPage?showDefenseProgram():"alumni"==currentPage?showAlumni():console.log("Unsupported operation on '"+currentPage+"'")}function showAlumni(){internships(function(ii){var missings=0;ii.forEach(function(i){0==i.Future.Position&&missings++}),ii.Missings=missings;var html=Handlebars.getTemplate("alumni")(ii),root=$("#cnt");root.html(html).find("td .icheckbox_flat").icheck({callbacks:{ifChecked:shiftSelect}}),$("#cnt").find(".check_all").icheck({callbacks:{ifChecked:function(){$("#cnt").find("td .icheckbox_flat").icheck("checked")},ifUnchecked:function(){$("#cnt").find("td .icheckbox_flat").icheck("unchecked")}}}),root.find(".tablesorter").tablesorter({theme:"bootstrap",widgets:["uitheme"],headerTemplate:"{content} {icon}",headers:{0:{sorter:!1}}})})}function showStatus(){students(function(stus){var placed=0,known=[],toPlace=stus.length;interns.filter(function(u){known.push(u.Student)}),conventions(function(cc){cc.forEach(function(conv){conv.Skip&&known.push(conv.Student)}),stus.forEach(function(s){null!=s.Internship&&s.Internship.length>0?known.forEach(function(k){return k.Email==s.Internship&&(s.Internship=k,placed++),!1}):s.Hidden&&toPlace--});var html=Handlebars.getTemplate("status")({Students:stus,Interns:known,Placed:placed,ToPlace:toPlace}),root=$("#cnt");root.html(html),$("#student-fullnames").on("click",function(){showFullnames(stus)}),$("#cnt").find(":checkbox").icheck();var idx=0;stus.forEach(function(stu){s=$("#select-"+idx++);var best=pickBestStudentMatching(stu,known);s.val(best)}),$("input[type=file]").filestyle({input:!1,buttonText:"Upload student list",buttonName:"btn-success btn-sm",iconName:"glyphicon-cloud-upload",badge:!1}),$(":file").change(function(){var file=this.files[0],size=(file.name,file.size),type=file.type;if("text/csv"!=type)reportError("Must be a CSV file");else if(size>1e6)reportError("The file cannot exceed 1MB");else{var reader=new FileReader;reader.onload=function(e){sendStudents(e.target.result,function(){refresh()})},reader.readAsText(file)}})})})}function showFullnames(source){var checked=$(".icheckbox.checked").find(":checkbox"),fns=[];if(checked.each(function(i,e){var em=$(e).attr("data-email");source.forEach(function(src){if(src.Email==em){var fn=src.Firstname.charAt(0).toUpperCase()+src.Firstname.slice(1),ln=src.Lastname.charAt(0).toUpperCase()+src.Lastname.slice(1),n=fn+" "+ln;fns.indexOf(n)<0&&fns.push(fn+" "+ln)}})}),fns.length>0){var html=Handlebars.getTemplate("raw");$("#modal").html(html),$("#rawContent").html(fns.join("\n")),$("#modal").modal("show")}}function pickBestStudentMatching(student,students){var best="";return students.forEach(function(s){return s.Email==student.Email?(best=s.Email,!1):void 0}),r=student.Lastname.toLowerCase(),r=r.replace(new RegExp(/[àáâãäå]/g),"a"),r=r.replace(new RegExp(/ç/g),"c"),r=r.replace(new RegExp(/[èéêë]/g),"e"),r=r.replace(new RegExp(/[ìíîï]/g),"i"),r=r.replace(new RegExp(/[òóôõö]/g),"o"),r=r.replace(new RegExp(/œ/g),"oe"),r=r.replace(new RegExp(/[ùúûü]/g),"u"),r=r.replace(new RegExp(/[ýÿ]/g),"y"),students.forEach(function(s){return s.Lastname==r?(best=s.Email,!1):void 0}),best}function displayMyStudents(){internships(function(data){interns=data.filter(function(i){return i.Tutor.Email==myself.Email});var html=Handlebars.getTemplate("tutoring")(interns),root=$("#cnt");return root.html(html),0==interns.length?!0:($("#cnt").find("td .icheckbox_flat").icheck({callbacks:{ifChecked:shiftSelect}}),$("#cnt").find(".check_all").icheck({callbacks:{ifChecked:function(){$("#cnt").find("td .icheckbox_flat").icheck("checked")},ifUnchecked:function(){$("#cnt").find("td .icheckbox_flat").icheck("unchecked")}}}),void $("#table-conventions").tablesorter({theme:"bootstrap",widgets:["uitheme"],headerTemplate:"{content} {icon}",headers:{0:{sorter:!1}}}))})}function displayMyConventions(){internships(function(data){interns=data;var html=Handlebars.getTemplate("watchlist")(interns),root=$("#cnt");if(root.html(html),myself.Role>=3){var sum=summary();$(".summary").html(Handlebars.getTemplate("summary")(sum))}return 0==interns.length?!0:($("#cnt").find("td .icheckbox_flat").icheck({callbacks:{ifChecked:shiftSelect}}),$("#cnt").find(".check_all").icheck({callbacks:{ifChecked:function(){$("#cnt").find("td .icheckbox_flat").icheck("checked")},ifUnchecked:function(){$("#cnt").find("td .icheckbox_flat").icheck("unchecked")}}}),void $("#table-conventions").tablesorter({theme:"bootstrap",widgets:["uitheme"],headerTemplate:"{content} {icon}",headers:{0:{sorter:!1}}}))})}function shiftSelect(e){if(document.getSelection().removeAllRanges(),shiftPressed)for(var myTd=$(e).closest("td"),tr=myTd.parent(),col=tr.children().index(myTd),p=tr.prev();p.length>0;){var chk=$(p.children().get(col)).find(".icheckbox");if(chk.hasClass("checked"))break;chk.icheck("checked"),p=p.prev()}}function showPrivileges(){sessions(function(ss){users(function(data){var teachers=[],students=[];data.filter(function(u){u.Last=ss[u.Email],0==u.Role&&myself.Email!=u.Email?students.push(u):myself.Email!=u.Email&&teachers.push(u)});var html=Handlebars.getTemplate("privileges")({Students:students,Teachers:teachers});$("#cnt").html(html),$("#cnt").find("select").selecter(),$("#cnt").find(":checkbox").icheck(),$('[data-toggle="delteacher-confirmation"]').each(function(i,a){var j=$(a);j.confirmation({onConfirm:function(){removeUser(j.attr("data-user"),j.parent().parent().parent())}})}),$('[data-toggle="teacher-reinvite"]').each(function(i,a){var j=$(a);j.confirmation({onConfirm:function(){reInvite(j.attr("data-user"))},btnOkLabel:'<i class="icon-ok-sign icon-white"></i> Confirm'})}),$('[data-toggle="student-reinvite"]').each(function(i,a){var j=$(a);j.confirmation({onConfirm:function(){resetPassword(j.attr("data-user"))},btnOkLabel:'<i class="icon-ok-sign icon-white"></i> Confirm'})}),$('[data-toggle="delstudent-confirmation"]').each(function(i,a){var j=$(a);j.confirmation({onConfirm:function(){removeUser(j.attr("data-user"),j.parent().parent())}})})})})}function removeUser(email,div){rmUser(email,function(){div.remove(),reportSuccess("Account deleted")})}function pickBestMatching(tutor,users){var res=void 0;if(users.forEach(function(t){var known_ln=t.Lastname;return tutor.Lastname.indexOf(known_ln)>-1||known_ln.indexOf(tutor.Lastname)>-1?(res=t,!1):void 0}),void 0==res){var firstLetter=tutor.Lastname[0];users.forEach(function(t){var knownFirstLetter=t.Lastname[0];firstLetter>=knownFirstLetter&&(res=t)})}return res||(res=users[0]),res}function showPendingConventions(){conventions(function(cc){users(function(uss){uss=uss.filter(function(u){return 0!=u.Role});var ignored=[];cc=cc.filter(function(c){return c.Skip&&ignored.push(c),!c.Skip}),$("#pending-counter").html(" <span class='badge'>"+cc.length+(ignored.length>0?"/"+ignored.length:"")+"</span>"),0==cc.length&&0==ignored.length&&$("#pending-counter").html(""),currentConvention=cc[0];var html=Handlebars.getTemplate("pending")({c:currentConvention,users:uss,Ignored:ignored});if($("#cnt").html(html),cc.length>0){var best=pickBestMatching(currentConvention.Tutor,uss);$("#known-tutor-selector").val(best.Email),$("#cnt").find("select").selecter(),best.Lastname==currentConvention.Tutor.Lastname?(d=$("#pick-theory"),d.confirmation({onConfirm:pickTheory,placement:"right",title:"Sure ? It's a perfect match !",btnOkLabel:'<i class="icon-ok-sign icon-white"></i> Confirm'}),d.removeAttr("onclick"),k=$("#btn-choose-known"),k.attr("onclick","pickKnown()"),k.confirmation("destroy")):(d=$("#pick-theory"),d.attr("onclick","pickTheory()"),d.confirmation("destroy"),k=$("#btn-choose-known"),k.confirmation({onConfirm:pickKnown,placement:"left",title:"Sure ? They differ !",btnOkLabel:'<i class="icon-ok-sign icon-white"></i> Confirm'}),k.removeAttr("onclick"))}})})}function pickTheory(){if(missing("th-tutor-fn")||missing("th-tutor-ln")||missing("th-tutor-email")||missing("th-tutor-tel"))return!1;var fn=$("#th-tutor-fn").val(),ln=$("#th-tutor-ln").val(),email=$("#th-tutor-email").val(),tel=$("#th-tutor-tel").val();newUser(fn,ln,tel,email,-1,function(){currentConvention.Tutor={Firstname:fn,Lastname:ln,Tel:tel,Email:email,Role:1},reportSuccess("Tutor account created"),newInternship(currentConvention,function(){reportSuccess("Internship added"),refresh()})},function(o){409==o.status?(reportSuccess("Tutor account already exists"),newInternship(currentConvention,function(){reportSuccess("Internship added"),refresh()})):reportError(o.responseText)})}function pickKnown(){user($("#known-tutor-selector").val(),function(us){currentConvention.Tutor=us,newInternship(currentConvention,function(){reportSuccess("Internship added"),refresh()})})}function showService(){internships(function(interns){var service={};interns.forEach(function(i){service[i.Tutor.Email]||(service[i.Tutor.Email]={P:i.Tutor,Internships:{}}),service[i.Tutor.Email].Internships[i.Promotion]||(service[i.Tutor.Email].Internships[i.Promotion]=[]),service[i.Tutor.Email].Internships[i.Promotion].push(i)});var html=Handlebars.getTemplate("service")(service);$("#cnt").html(html),$("#cnt").find("td .icheckbox_flat").icheck({callbacks:{ifChecked:shiftSelect}}),$("#cnt").find(".check_all").icheck({callbacks:{ifChecked:function(){$("#cnt").find("td .icheckbox_flat").icheck("checked")},ifUnchecked:function(){$("#cnt").find("td .icheckbox_flat").icheck("unchecked")}}})})}function nbDaysLate(deadline,now){now||(now=new Date);var d1=moment(deadline),d2=moment(now);return d1-d2}var interns,currentPage,waitingBlock,myself,currentConvention,allMajors,shiftPressed=!1;$(document).ready(function(){waitingBlock=$("#cnt").clone().html(),majors(function(m){allMajors=m}),user(getCookie("session"),function(u){myself=u,$("#fullname").html(u.Firstname+" "+u.Lastname),showMyServices(u.Role),myself.Role>=2?showPage(void 0,"conventions"):showPage(void 0,"myStudents")}),$(document).keydown(function(e){16==e.keyCode&&(shiftPressed=!0)}),$(document).keyup(function(e){16==e.keyCode&&(shiftPressed=!1)})}),String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substring(1)}}();