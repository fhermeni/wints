function showPage(a,b){$("#cnt").html(waitingBlock),$("#menu-pages").find("li").removeClass("active"),a&&$(a.parentNode).addClass("active"),currentPage=b,refresh()}function refresh(){"myStudents"==currentPage?displayMyStudents():"conventions"==currentPage?displayMyConventions():"assignments"==currentPage?displayTutors():"privileges"==currentPage?showPrivileges():"defenses-schedule"==currentPage?showDefenses("schedule"):"defenses-juries"==currentPage?showDefenses("juries"):"pending"==currentPage?showPendingConventions():"juries"==currentPage?showJuryService():"service"==currentPage?showService():console.log("Unsupported operation on '"+currentPage+"'")}function displayMyStudents(){internships(function(a){interns=a.filter(function(a){return a.Tutor.Email==myself.Email});var b=Handlebars.getTemplate("tutoring")(interns),c=$("#cnt");return c.html(b),0==interns.length?!0:($("#table-conventions").tablesorter({theme:"bootstrap",widgets:["uitheme"],headerTemplate:"{content} {icon}",headers:{0:{sorter:!1}}}),$("#cnt").find(":checkbox").iCheck(),$("#cnt").find(".check_all").on("ifChecked",function(){$("#cnt").find("td .icheckbox").iCheck("check")}).on("ifUnchecked",function(){$("#cnt").find("td .icheckbox").iCheck("unCheck")}),$("#cnt").find("td .icheckbox").on("ifChecked",shiftSelect),void 0)})}function displayMyConventions(){internships(function(a){interns=a;var b=Handlebars.getTemplate("watchlist")(interns),c=$("#cnt");return c.html(b),0==interns.length?!0:($("#table-conventions").tablesorter({theme:"bootstrap",widgets:["uitheme"],headerTemplate:"{content} {icon}",headers:{0:{sorter:!1}}}),$("#cnt").find(":checkbox").iCheck(),$("#cnt").find(".check_all").on("ifChecked",function(){$("#cnt").find("td .icheckbox").iCheck("check")}).on("ifUnchecked",function(){$("#cnt").find("td .icheckbox").iCheck("unCheck")}),$("#cnt").find("td .icheckbox").on("ifChecked",shiftSelect),void 0)})}function shiftSelect(a){if(shiftPressed)for(var b=$(a.currentTarget).closest("td"),c=b.parent(),d=c.children().index(b),e=c.prev();e.length>0;){var f=$(e.children().get(d)).find(".icheckbox");if(f.hasClass("checked"))break;f.iCheck("check"),e=e.prev()}}function showPrivileges(){users(function(a){var b=a.filter(function(a){return a.Email!=myself.Email&&0!=a.Role}),c=Handlebars.getTemplate("privileges")(b);$("#cnt").html(c),$("#cnt").find("select").selecter(),$('[data-toggle="deluser-confirmation"]').each(function(a,b){var c=$(b);c.confirmation({onConfirm:function(){removeUser(c.attr("data-user"),c.parent().parent().parent())}})})})}function showNewUser(){var a=Handlebars.getTemplate("new-user")({});$("#modal").html(a).modal("show"),$("#modal").find("select").selecter()}function addUser(){return missing("lbl-nu-fn")||missing("lbl-nu-ln")||missing("lbl-nu-email")?!1:(newUser($("#lbl-nu-fn").val(),$("#lbl-nu-ln").val(),$("#lbl-nu-tel").val(),$("#lbl-nu-email").val(),parseInt($("#lbl-nu-priv").val()),function(){$("#modal").modal("hide"),reportSuccess("Account created"),refresh()},function(a){409==a.status&&$("#lbl-nu-email").notify(a.responseText)}),void 0)}function removeUser(a,b){rmUser(a,function(){b.remove(),reportSuccess("Account deleted")})}function pickBestMatching(a,b){var c=void 0;if(b.forEach(function(b){var d=b.Lastname;return a.Lastname.indexOf(d)>-1||d.indexOf(a.Lastname)>-1?(c=b,!1):void 0}),void 0==c){var d=a.Lastname[0];b.forEach(function(a){var b=a.Lastname[0];d>=b&&(c=a)})}return c||(c=b[0]),c}function showPendingConventions(){conventions(function(a){users(function(b){b=b.filter(function(a){return 0!=a.Role});var c=[];if(a=a.filter(function(a){return a.Skip&&c.push(a),!a.Skip}),$("#pending-counter").html(" <span class='badge'>"+a.length+(c.length>0?"/"+c.length:"")+"</span>"),0==a.length&&0==c.length)return $("#pending-counter").html(""),$("#cnt").html("<h5 class='text-center'>Nothing to import</h5>"),void 0;currentConvention=a[0];var e=Handlebars.getTemplate("pending")({c:currentConvention,users:b,Ignored:c});if($("#cnt").html(e),a.length>0){var f=pickBestMatching(currentConvention.Tutor,b);$("#known-tutor-selector").val(f.Email),$("#cnt").find("select").selecter(),f.Lastname==currentConvention.Tutor.Lastname?(d=$("#pick-theory"),d.confirmation({onConfirm:pickTheory,placement:"right",title:"Sure ? It's a perfect match !",btnOkLabel:'<i class="icon-ok-sign icon-white"></i> Confirm'}),d.removeAttr("onclick"),k=$("#btn-choose-known"),k.attr("onclick","pickKnown()"),k.confirmation("destroy")):(d=$("#pick-theory"),d.attr("onclick","pickTheory()"),d.confirmation("destroy"),k=$("#btn-choose-known"),k.confirmation({onConfirm:pickKnown,placement:"left",title:"Sure ? They differ !",btnOkLabel:'<i class="icon-ok-sign icon-white"></i> Confirm'}),k.removeAttr("onclick"))}})})}function sendSkipConvention(a,b){skipConvention(a,b,function(){b?reportSuccess("Convention ignored"):reportSuccess("The convention is no longer ignored"),refresh()})}function pickTheory(){if(missing("th-tutor-fn")||missing("th-tutor-ln")||missing("th-tutor-email")||missing("th-tutor-tel"))return!1;var a=$("#th-tutor-fn").val(),b=$("#th-tutor-ln").val(),c=$("#th-tutor-email").val(),d=$("#th-tutor-tel").val();newUser(a,b,d,c,-1,function(){currentConvention.Tutor={Firstname:a,Lastname:b,Tel:d,Email:c,Role:1},reportSuccess("Tutor account created"),newInternship(currentConvention,function(){reportSuccess("Internship added"),refresh()})},function(a){409==a.status?(reportSuccess("Tutor account already exists"),newInternship(currentConvention,function(){reportSuccess("Internship added"),refresh()})):reportError(jqr.responseText)})}function pickKnown(){user($("#known-tutor-selector").val(),function(a){currentConvention.Tutor=a,newInternship(currentConvention,function(){reportSuccess("Internship added"),refresh()})})}function mailing(a){var b=[],c=[];$(".icheckbox.checked").find(":checkbox").each(function(d,e){var f=$(e).attr("data-email");b.push(f);var d=getInternship(f);d&&"tutor"==a&&c.push(d.Tutor.Email)}),b.length>0&&(window.location.href="mailto:"+b.join(",")+(c.length>0?"?cc="+c.join(","):""))}function getInternship(a){var b=void 0;return interns.forEach(function(c){return c.Student.Email==a?(b=c,!1):void 0}),b}function showService(){internships(function(a){var b={};a.forEach(function(a){b[a.Tutor.Email]?b[a.Tutor.Email].Internships.push(a):b[a.Tutor.Email]={P:a.Tutor,Internships:[a]}});var c=Handlebars.getTemplate("service")(b);$("#cnt").html(c),$("#cnt").find(":checkbox").iCheck(),$("#cnt").find(".check_all").on("ifChecked",function(){$("#cnt").find("td .icheckbox").iCheck("check")}).on("ifUnchecked",function(){$("#cnt").find("td .icheckbox").iCheck("unCheck")}),$("#cnt").find("td .icheckbox").on("ifChecked",shiftSelect)})}function showRawService(){internships(function(a){var b={};a.forEach(function(a){b[a.Tutor.Email]?b[a.Tutor.Email].Internships.push(a):b[a.Tutor.Email]={P:a.Tutor,Internships:[a],Juries:{}}}),console.log(b);var c=Handlebars.getTemplate("raw-service")(b);$("#modal").html(c).modal("show")})}function showRawFullname(){var b=$(".icheckbox.checked").find(":checkbox"),c=[];if(b.each(function(a,b){var d=$(b).attr("data-email"),a=getInternship(d);c.push(a.Student.Firstname+" "+a.Student.Lastname)}),c.length>0){var d=Handlebars.getTemplate("raw");$("#modal").html(d),$("#rawContent").html(c.join("\n")),$("#modal").modal("show")}}function selectText(a){if(document.body.createTextRange){var b=document.body.createTextRange();b.moveToElementText(a),b.select()}else if(window.getSelection){var c=window.getSelection(),b=document.createRange();b.selectNodeContents(a),c.removeAllRanges(),c.addRange(b)}}function showInternship(a){internship(a,function(a){users(function(b){b=b.filter(function(a){return 0!=a.Role}),buf=Handlebars.getTemplate("student")({I:a,Admin:myself.Role>=3,Major:myself.Role>=2,Tutors:b}),$("#modal").html(buf).modal("show");var c=$("#modal").find("select.select-tutor");c.val(a.Tutor.Email),$("#modal").find("select.select-major").selecter({callback:function(b){sendMajor(a.Student.Email,b)}}),$("#modal").find("select.select-tutor").selecter({callback:function(b){sendTutor(a.Student.Email,b)}})})})}function showReport(a,b){reportHeader(a,b,function(c){c.Reviewable=-2!=c.Grade,c.Email=a,buf=Handlebars.getTemplate("reportEditor")(c),$("#modal").html(buf).modal("show"),$(":checkbox").iCheck().on("ifChecked",function(){setReportPrivate(a,b,!0)}).on("ifUnchecked",function(){setReportPrivate(a,b,!1)}),$(".date").datepicker({format:"d M yyyy",autoclose:!0,minViewMode:0,weekStart:1}).on("changeDate",function(c){setReportDeadline(a,b,c.date)})})}function sendMajor(a,b){setMajor(a,b,function(){reportSuccess("Major updated"),refresh()})}function sendTutor(a,b){setTutor(a,b,function(){reportSuccess("Tutor updated"),refresh()})}var interns,currentPage,waitingBlock,myself,currentConvention,shiftPressed=!1,allMajors;$(document).ready(function(){waitingBlock=$("#cnt").clone().html(),majors(function(a){allMajors=a}),user(getCookie("session"),function(a){myself=a,$("#fullname").html(a.Firstname+" "+a.Lastname),showMyServices(a.Role),myself.Role>=2?showPage(void 0,"conventions"):showPage(void 0,"myStudents")}),$(document).keydown(function(a){16==a.keyCode&&(shiftPressed=!0)}),$(document).keyup(function(a){16==a.keyCode&&(shiftPressed=!1)})});